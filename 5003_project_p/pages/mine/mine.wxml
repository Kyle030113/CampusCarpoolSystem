<view class="page-mine" style="padding-bottom:60px;">

<view class="user-info" style="padding:12px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;">
  <view>
    <text style="font-weight:700;">{{userInfo && userInfo.nickName}}</text>
    <text style="display:block;color:#888;font-size:12px;margin-top:4px;">发布/参与的行程</text>
  </view>
  <view>
    <button bindtap="logout" style="background:#ff4d4f;color:#fff;padding:6px 10px;border-radius:6px;">退出登录</button>
  </view>
</view>

<view class="tabs" style="display:flex;border-bottom:1px solid #f0f0f0;">
  <view bindtap="switchTab" data-index="0" style="flex:1;text-align:center;padding:12px;border-bottom:{{activeTab===0?'2px solid #1aad19':'none'}};">
    <text style="{{activeTab===0?'color:#1aad19;font-weight:700;':'color:#666;'}}">进行中 ({{ongoingList.length}})</text>
  </view>
  <view bindtap="switchTab" data-index="1" style="flex:1;text-align:center;padding:12px;border-bottom:{{activeTab===1?'2px solid #1aad19':'none'}};">
    <text style="{{activeTab===1?'color:#1aad19;font-weight:700;':'color:#666;'}}">已结束 ({{finishedList.length}})</text>
  </view>
</view>

<view wx:if="{{activeTab===0}}">
  <block wx:for="{{ongoingList}}" wx:key="carpoolId" wx:for-item="item">
    <view style="padding:12px;border-bottom:1px solid #eee;">
      <view style="display:flex;justify-content:space-between;align-items:center;">
        <view style="flex:1;">
          <view style="font-weight:700;color:#e53935;margin-bottom:6px;">{{item.displayOrigin || '未知出发地'}} → <text style="color:#2e7d32;">{{item.displayDestination || '未知目的地'}}</text></view>
          <view style="color:#666;">出发时间：{{item.displayDeparture}}</view>
          <view style="color:#999;font-size:12px;margin-top:6px;">
            <text wx:if="{{item.relation==='publisher'}}">你发布的行程</text>
            <text wx:elif="{{item.relation==='joined'}}">你已加入</text>
          </view>
        </view>
        <view style="display:flex;flex-direction:column;align-items:flex-end;margin-left:12px;">
          <button bindtap="openDetail" data-id="{{item.carpoolId}}" style="background:#1aad19;color:#fff;padding:6px 10px;border-radius:4px;margin-bottom:8px;">查看</button>

          <block wx:if="{{item.relation==='publisher' && !item.isFinished}}">
            <button bindtap="finishTrip" data-id="{{item.carpoolId}}" data-disabled="{{finishingId===item.carpoolId}}" style="background:#f5f5f5;color:#333;padding:6px 10px;border-radius:4px;margin-bottom:8px;">
              <text wx:if="{{finishingId===item.carpoolId}}">结束中...</text>
              <text wx:else>结束</text>
            </button>
          </block>

          <!-- New: for joined users, show 退出按钮 (only when not finished) -->
          <block wx:if="{{item.relation==='joined' && !item.isFinished}}">
            <button bindtap="quitJoin" data-id="{{item.carpoolId}}" style="background:#fff;border:1px solid #f56c6c;color:#f56c6c;padding:6px 10px;border-radius:4px;">退出</button>
          </block>
        </view>
      </view>
    </view>
  </block>
  <view wx:if="{{ongoingList.length===0}}" style="padding:24px;text-align:center;color:#999;">暂无进行中行程</view>
</view>

<view wx:elif="{{activeTab===1}}">
  <block wx:for="{{finishedList}}" wx:key="carpoolId" wx:for-item="item">
    <view style="padding:12px;border-bottom:1px solid #eee;">
      <view style="font-weight:700;color:#999;margin-bottom:6px;">{{item.displayOrigin || '未知出发地'}} → <text style="color:#999;">{{item.displayDestination || '未知目的地'}}</text></view>
      <view style="color:#666;">出发时间：{{item.displayDeparture}}</view>
      <view style="color:#999;font-size:12px;margin-top:6px;">
        <text wx:if="{{item.relation==='publisher'}}">你发布的行程</text>
        <text wx:elif="{{item.relation==='joined'}}">你已加入</text>
      </view>
    </view>
  </block>
  <view wx:if="{{finishedList.length===0}}" style="padding:24px;text-align:center;color:#999;">暂无已结束行程</view>
</view>
</view>